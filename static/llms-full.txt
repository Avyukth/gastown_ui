# Gastown UI - Complete Documentation
# Generated: 2026-01-14T17:51:45.824Z
# Version: 0.1.0

================================================================================
SECTION 1: PROJECT OVERVIEW
================================================================================

# Gastown UI

Frontend for the Gas Town orchestration dashboard. This repo powers the
operator console for agents, convoys, merge activity, and system health.

## Features

- Multi-column dashboard with agents, workflows, queue, stats, and actions
- Agent detail pages with status, progress, and diagnostics
- Convoy tracking for batched work
- Work management (issues, convoys, sling targets)
- Logs, activity feed, rigs, settings, and health views

## Tech Stack

- SvelteKit + Vite
- Tailwind CSS + tailwind-variants
- lucide-svelte icons
- Bun or npm for tooling

## Screenshots

Add screenshots to `static/screenshots/` and reference here, for example:

```
![Dashboard](static/screenshots/dashboard.png)
```

## Quickstart

Requirements:
- Node.js 18+ (or Bun 1.1+)
- Git

Install dependencies:

```bash
bun install
```

Run the dev server:

```bash
bun run dev
```

Open `http://localhost:5173`.

## Build and Preview

```bash
bun run build
bun run preview
```

## Scripts

- `dev`: start local dev server
- `build`: production build
- `preview`: serve production build
- `check`: SvelteKit sync + typecheck
- `analyze`: build with bundle analyzer (`ANALYZE=true`)

## Repo Structure

```
src/
  lib/
    components/    Reusable UI components
    api/           Client utilities and API glue
    stores/        Client state and sockets
  routes/          SvelteKit pages and layouts
static/            Static assets
```

## Development Workflow

- Create a branch for each task.
- Keep changes scoped; update or add tests where applicable.
- Prefer reusable components in `src/lib/components`.
- Use semantic tokens from `src/app.css` and `tailwind.config.js`.

## Deployment

This is a standard SvelteKit/Vite build. Use your hosting provider’s static
or node adapter flow as appropriate. The build output is generated by
`bun run build`.

## Contribution

- Keep commit messages concise.
- Avoid introducing new deps unless necessary.
- Maintain accessibility and keyboard support on interactive views.
- Follow the testing policy below.

## Testing Policy (Non-Negotiable)

Playwright is **not** used for this project.

Use **Claude in Chrome tools** for all UI verification and manual checks.
Do not introduce Playwright-based tests or references in plans or execution.

## Design System

Semantic tokens in `src/app.css` following shadcn conventions:

- **Core**: `--background`, `--foreground`, `--card`, `--muted`, `--border`
- **Status**: `--success`, `--warning`, `--info`, `--destructive`
- **Agent**: `--status-online`, `--status-offline`, `--status-pending`, `--status-idle`
- **Typography**: Inter (body), Space Grotesk (headlines), JetBrains Mono (code)
- **Utilities**: `.panel-glass`, `.touch-target`, `.stagger` animations

## Component Library

70+ components in `src/lib/components/` using Svelte 5 runes and `tailwind-variants`:

- **Core**: Button, Badge, Input, Switch, Icon
- **Layout**: DashboardLayout, PageHeader, SplitView
- **Status**: StatusIndicator, ProgressBar, Toast
- **Loading**: Skeleton, SkeletonGroup, NavigationLoader
- **A11y**: Announcer, LiveRegion, SkipLink, KeyboardHelpDialog
- **Mobile**: BottomNav, SwipeableItem, PullToRefresh, OfflineIndicator

## Utilities

- **Logger** (`$lib/utils/logger.ts`): Namespaced debug logging, environment-aware
- **Keyboard** (`$lib/utils/keyboard.ts`): Global shortcuts with platform detection
- **Gestures** (`$lib/utils/gestures.ts`): Swipe and pull-to-refresh detection

## Real-Time

WebSocket client (`$lib/stores/websocket.svelte.ts`) with:
- Exponential backoff reconnection (1s base, 30s max, 20% jitter)
- Heartbeat/ping-pong (30s interval, 5s timeout)
- Browser online/offline event integration

## Security

Configured in `src/hooks.server.ts`:
- CSP headers (self + fonts.googleapis.com)
- CSRF double-submit cookie pattern
- HttpOnly auth cookies
- Security headers (X-Frame-Options, HSTS in prod, etc.)

## Accessibility

- WCAG 2.5.5 AAA touch targets (48px min)
- Safe area insets for notched devices
- Screen reader live regions
- `prefers-reduced-motion` support

## Environment

```bash
VITE_WS_URL=ws://localhost:8080/ws
VITE_MOCK_API=true
```

## Notes

- `bun.lockb` is the Bun lockfile.
- `BUNDLE_ANALYSIS.md` documents the latest bundle audit.


================================================================================
SECTION 2: API ENDPOINTS
================================================================================

### POST /api/auth/login

### POST /api/auth/logout

### GET /api/auth/me

### POST /api/auth/refresh

### GET /api/gastown/convoys

### POST /api/gastown/escalations/:id/resolve

### GET /api/gastown/mail

### GET /api/gastown/rigs

### GET /api/gastown/snapshot

### GET /api/gastown/status

### POST /api/gastown/work/convoys

### GET /api/gastown/work/issues

### POST /api/gastown/work/issues

### POST /api/gastown/work/sling

### POST /api/gastown/workflows/cook

### GET /api/gastown/workflows/formulas

### GET /api/gastown/workflows/formulas/:name

### GET /api/gastown/workflows/molecules

### POST /api/gastown/workflows/pour

================================================================================
SECTION 3: COMPONENTS
================================================================================

## Accessibility
- Announcer.svelte
- KeyboardHelpDialog.svelte
- LiveRegion.svelte
- SkipLink.svelte
- TouchTarget.svelte

## Core
- Badge.svelte
- Button.svelte
- Icon.svelte
- Input.svelte
- Switch.svelte

## Data
- ActivityFeed.svelte
- AgentCard.svelte
- DataTable.svelte
- LogEntry.svelte
- StatsCard.svelte
- VirtualList.svelte

## Feedback
- ApiError.svelte
- EmptyState.svelte
- ErrorBoundary.svelte
- ErrorState.svelte
- Toast.svelte
- ToastContainer.svelte

## Layout
- BottomNav.svelte
- Dashboard.svelte
- DashboardLayout.svelte
- PageHeader.svelte
- SheetNav.svelte
- Sidebar.svelte
- SplitView.svelte

## Loading
- NavigationLoader.svelte
- Skeleton.svelte
- SkeletonCard.svelte
- SkeletonGroup.svelte
- SkeletonLoader.svelte

## Mobile
- FloatingActionButton.svelte
- OfflineIndicator.svelte
- PullToRefresh.svelte
- SwipeableItem.svelte
- SwipeableTabs.svelte

## Other
- AgentCardSkeleton.svelte
- AgentDetailLayout.svelte
- ConnectionLost.svelte
- DegradedModeBanner.svelte
- GridPattern.svelte
- IssueTypeSelector.svelte
- KnownBugDetector.svelte
- LogEntrySkeleton.svelte
- LogsLayout.svelte
- MobileDashboard.svelte
- NumberCounter.svelte
- OperationCenter.svelte
- QueueLayout.svelte
- ShimmerText.svelte
- ThemeToggle.svelte
- UnreadDot.svelte
- UpdatePrompt.svelte
- WorkflowLayout.svelte

## Status
- CircularProgress.svelte
- ProgressBar.svelte
- StatusBadge.svelte
- StatusIndicator.svelte

================================================================================
SECTION 4: UI PAGES
================================================================================

- /
- /activity
- /agents
- /agents/[id]
- /convoys
- /convoys/[id]
- /crew
- /dogs
- /escalations
- /escalations/[id]
- /health
- /issues/[id]
- /login
- /login/mobile
- /logs
- /mail
- /mail/[id]
- /mail/compose
- /queue
- /rigs
- /seance
- /settings
- /stats
- /watchdog
- /work
- /workflows

================================================================================
SECTION 5: KNOWN ISSUES
================================================================================

## Open Tasks
- [gu-0pq3] P1: Implement Dashboard page component
- [gu-335i] P1: Implement shared test logging utilities
- [gu-bz5x] P1: Unit tests: Toast system and ID extraction helpers
- [gu-ve52] P1: Integration tests: API endpoints with real CLI
- [gu-ygmi] P1: Implement /api/gastown/snapshot coherent data endpoint
- [gu-83zz] P1: Implement Degraded Mode Banner component
- [gu-vyg7] P1: Accessibility tests with axe-core
- [gu-h30x] P1: CI Workflow: Contract Tests
- [gu-kvvy] P1: Smoke tests: CUJ-6 Keyboard Navigation
- [gu-0ual] P1: Smoke tests: CUJ-5 Mail View
- [gu-shp7] P1: Smoke tests: CUJ-4 System Monitoring (Dashboard)
- [gu-44ug] P1: Smoke tests: CUJ-3 Orchestration (Sling)
- [gu-e8eu] P1: Smoke tests: CUJ-2 Work Item Lifecycle
- [gu-opvu] P1: Smoke tests: CUJ-1 Rig Management
- [gu-r2pm] P1: Unit tests: Activity Stream (SSE Client)
- [gu-qwqq] P1: Unit tests: Known Bug Detection
- [gu-9mtr] P1: Unit tests: Operations Store
- [gu-l0uq] P1: Unit tests: Circuit Breaker
- [gu-9n9] P1: Unit tests: Capabilities Probe
- [gu-p1o] P1: Unit tests: Concurrency Limiter

================================================================================
SECTION 6: AGENT INSTRUCTIONS
================================================================================

# Agent Instructions

This project uses **bd** (beads) for issue tracking. Run `bd onboard` to get started.

## Project Structure

```
gastown-ui/                          # Town root
├── .beads/                          # Town-level beads (mayor mail, HQ coordination)
├── AGENTS.md                        # This file
├── CLAUDE.md                        # Mayor context
│
└── gastown-ui/                      # Rig: SvelteKit UI project
    ├── .repo.git/                   # Bare git repository (shared by all worktrees)
    │
    ├── mayor/
    │   ├── rig/                     # Mayor's reference clone (READ-ONLY)
    │   │   └── .beads/              # Rig beads database (source of truth)
    │   └── state.json
    │
    ├── polecats/                    # Worker worktrees
    │   ├── furiosa/                 # Polecat worktree
    │   │   └── .beads/redirect      # → ../../mayor/rig/.beads
    │   └── nux/                     # Polecat worktree
    │       └── .beads/redirect      # → ../../mayor/rig/.beads
    │
    ├── refinery/
    │   └── rig/                     # Merge queue processor worktree (on main)
    │       └── .beads/redirect      # → ../../mayor/rig/.beads
    │
    ├── crew/                        # Human-managed worktrees
    │   └── amrit/
    │
    └── witness/                     # Polecat lifecycle monitor
        └── state.json
```

### Key Concepts

| Component | Purpose |
|-----------|---------|
| **Town** | Workspace root containing all rigs |
| **Rig** | Project container (one per repo) |
| **Polecat** | Worker agent with isolated git worktree |
| **Refinery** | Merge queue processor (rebases, tests, merges) |
| **Witness** | Monitors polecat lifecycle |
| **Beads** | Issue tracking, shared via redirect to mayor/rig/.beads |

## Quick Reference

```bash
bd ready              # Find available work
bd show <id>          # View issue details
bd update <id> --status in_progress  # Claim work
bd close <id>         # Complete work
bd sync               # Sync with git
```

## Landing the Plane (Session Completion)

**When ending a work session**, you MUST complete ALL steps below. Work is NOT complete until `git push` succeeds.

**MANDATORY WORKFLOW:**

1. **File issues for remaining work** - Create issues for anything that needs follow-up
2. **Run quality gates** (if code changed) - Tests, linters, builds
3. **Update issue status** - Close finished work, update in-progress items
4. **PUSH TO REMOTE** - This is MANDATORY:
   ```bash
   git pull --rebase
   bd sync
   git push
   git status  # MUST show "up to date with origin"
   ```
5. **Clean up** - Clear stashes, prune remote branches
6. **Verify** - All changes committed AND pushed
7. **Hand off** - Provide context for next session

**CRITICAL RULES:**
- Work is NOT complete until `git push` succeeds
- NEVER stop before pushing - that leaves work stranded locally
- NEVER say "ready to push when you are" - YOU must push
- If push fails, resolve and retry until it succeeds

---

## Critical Fixes Phase - Patterns & Discoveries

### Form Validation Pattern

**When**: All user forms need to validate input before submission

**Pattern**:
```typescript
import { z } from 'zod';

// 1. Define validation schema
const formSchema = z.object({
  title: z.string().min(3, 'Title must be at least 3 characters'),
  type: z.enum(['task', 'bug', 'feature', 'epic']),
  priority: z.number().min(0).max(4)
});

// 2. In form handler, validate BEFORE submission
async function handleSubmit(e: Event) {
  e.preventDefault();
  errors = {};
  
  const result = formSchema.safeParse({
    title: formTitle,
    type: selectedType,
    priority: selectedPriority
  });
  
  if (!result.success) {
    const fieldErrors = result.error.flatten().fieldErrors;
    errors = Object.fromEntries(
      Object.entries(fieldErrors).map(([key, msgs]) => [key, msgs?.[0] || ''])
    );
    hapticError();
    return; // Don't submit
  }
  
  // Continue with submission
}

// 3. Display errors inline
{#if errors.title}
  <p class="text-sm text-destructive">{errors.title}</p>
{/if}

// 4. Disable submit until valid
<button disabled={formTitle.length < 3}>Submit</button>
```

**Applied To**:
- Work page: Issue creation, Convoy creation, Sling work forms

**Key Points**:
- Use Zod for client-side validation (npm install zod)
- Validate on submit, not on blur
- Show specific error messages per field
- Disable submit button while invalid
- Clear errors on successful submission

---

### Error State Integration Pattern

**When**: Any page that fetches data asynchronously

**Pattern**:
```svelte
<script>
  let error: Error | null = null;
  let loading = true;
  
  async function fetchData() {
    try {
      const res = await fetch('/api/data');
      if (!res.ok) throw new Error('Failed to fetch');
      data = await res.json();
    } catch (e) {
      error = e instanceof Error ? e.message : 'Unknown error';
    } finally {
      loading = false;
    }
  }
  
  function handleRetry() {
    error = null;
    fetchData();
  }
  
  onMount(() => {
    fetchData();
  });
</script>

{#if loading}
  <SkeletonCard type="mail" count={5} />
{:else if error}
  <ErrorState
    title="Failed to load"
    message={error}
    onRetry={handleRetry}
    showRetryButton={true}
  />
{:else if data.length === 0}
  <EmptyState title="No data" description="Create your first item" />
{:else}
  <!-- Content here -->
{/if}
```

**Applied To**:
- Mail page
- Agents page
- Work page
- Any async data fetch

**Key Points**:
- Always have loading, error, empty, and content states
- Error state should show specific error message
- Retry button re-fetches data
- Clear error on successful retry
- Use haptic feedback for errors

---

### Testing Procedures

**Created Documentation**:
1. **KEYBOARD_TESTING.md** - Tab order, focus, screen readers (VoiceOver, NVDA)
2. **DARK_MODE_TESTING.md** - Contrast ratios, WAVE, axe DevTools
3. **PERFORMANCE_TESTING.md** - Lighthouse, Core Web Vitals, 3G throttle
4. **BROWSER_TESTING.md** - Chrome, Firefox, Safari, iOS, Android

**Use These For**:
- Pre-launch verification
- Weekly/monthly monitoring
- Regression detection
- Accessibility compliance

**Success Criteria**:
- Lighthouse ≥90 on all pages
- LCP <2.5s on 3G
- Zero console errors
- Keyboard nav works on all pages
- 4.5:1 contrast in dark mode
- Works on Chrome, Firefox, Safari, iOS, Android

---

### Known Patterns & Gotchas

**Safe Area Insets (iOS)**:
- Use `env(safe-area-inset-bottom)` for bottom nav padding
- Apply to: BottomNav, floating buttons
- Formula: `padding-bottom: calc(height + env(safe-area-inset-bottom))`

**100vh Issue (Mobile Safari)**:
- 100vh includes address bar, causes overflow
- Use `100dvh` (dynamic viewport height) instead
- Or use `height: 100%` with full-height parent

**Select Dropdown Styling (Safari iOS)**:
- Cannot be styled on iOS Safari
- Accept default native styling
- Consider custom component for critical dropdowns

**Focus Management**:
- Always provide visible focus ring (2px ring-offset)
- Use Tailwind: `focus:ring-2 focus:ring-accent`
- Test with keyboard (Tab key)
- Verify with keyboard-only mode (disconnect mouse)

**Dark Mode Support**:
- Use CSS custom properties (--color-*)
- Test with: System dark mode, browser dark mode toggle
- Minimum contrast: 4.5:1 for all text

---

## Package Manager: Bun

**IMPORTANT**: This project uses **bun** as the package manager. Do NOT use npm, yarn, or pnpm.

```bash
# Install dependencies
bun install

# Add a new package
bun add <package>

# Add dev dependency
bun add -d <package>

# Run scripts
bun run dev
bun run build
bun run check

# Run tests
bun test
```

**Lock file**: `bun.lockb` - Do NOT create or commit `package-lock.json`, `yarn.lock`, or `pnpm-lock.yaml`.

## Dependencies Added

```json
{
  "dependencies": {
    "zod": "^3.22.0"  // Client-side form validation
  }
}
```

Install with: `bun add zod`

---

## File Locations

| Purpose | Location |
|---------|----------|
| Form validation | `/src/routes/work/+page.svelte` (schemas at top of script) |
| Error state pattern | Mail, Agents, Work pages |
| Empty state component | `$lib/components/EmptyState.svelte` |
| Skeleton loaders | `$lib/components/SkeletonCard.svelte` |
| Keyboard testing | `KEYBOARD_TESTING.md` |
| Dark mode testing | `DARK_MODE_TESTING.md` |
| Performance testing | `PERFORMANCE_TESTING.md` |
| Browser testing | `BROWSER_TESTING.md` |



================================================================================
END OF DOCUMENTATION
================================================================================